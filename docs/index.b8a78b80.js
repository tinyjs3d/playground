var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,o=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,a=(e,t)=>{for(var n in t||(t={}))i.call(t,n)&&o(e,n,t[n]);if(r)for(var n of r(t))l.call(t,n)&&o(e,n,t[n]);return e},s=(e,t,n)=>(o(e,"symbol"!=typeof t?t+"":t,n),n);import{_ as c,m as d,R as m,B as u,T as h,I as p,D as g,a as y,b as E,S as f,c as T,d as v}from"./vendor.752360b2.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class b extends Tiny.Container{constructor(e){super(),s(this,"option"),s(this,"model"),s(this,"setLights",(e=>{const t=new(0,Tiny.three.glTFLightParser)(e).getLightCfg();Tiny.three.LightingEnvironment.main.lights=[],t.forEach((e=>{const t=Object.assign(new Tiny.three.Light,e);Tiny.three.LightingEnvironment.main.lights.push(t)})),Tiny.three.LightingEnvironment.main.lights.push(Object.assign(new Tiny.three.Light,{color:[1,1,1],intensity:.1,type:Tiny.three.LightType.ambient}))})),this.option=e,this.init()}async init(){try{const e=await this.loadResource(),t=e.scene.gltf,n=e.model.gltf;this.setEnvironmentLight(t),this.setLights(n),this.model=Tiny.three.Model.from(n),this.addChild(this.model)}catch(e){alert("模型渲染失败，请检查你输入的 gltf 链接")}}_destroy(){var e;null==(e=null==this?void 0:this.model)||e.meshes.forEach((e=>e.destroy()))}loadResource(){var e,t,n;const{model:r}=this.option,i=new Tiny.loaders.Loader;return i.add({name:"model",url:r,metadata:{mimeType:"model/gltf+json"},xhrType:null==(n=null==(t=null==(e=null==Tiny?void 0:Tiny.loaders)?void 0:e.Resource)?void 0:t.XHR_RESPONSE_TYPE)?void 0:n.JSON}),i.add({name:"scene",url:"https://gw.alipayobjects.com/os/H5App-BJ/1632466215699-gltf/scene.gltf"}),new Promise(((e,t)=>{i.load(((t,n)=>{e(n)})).on("error",(e=>{t(e)}))}))}setEnvironmentLight(e){var t,n;if(null==(n=null==(t=null==e?void 0:e.descriptor)?void 0:t.extensions)?void 0:n.EXT_lights_image_based.lights){const t=e.descriptor.extensions.EXT_lights_image_based.lights[0],n=e.images,r=[],i=[],l=["POSITIVE_X","NEGATIVE_X","POSITIVE_Y","NEGATIVE_Y","NEGATIVE_Z","POSITIVE_Z"];for(let e=0;e<l.length;e++){const o=`TEXTURE_CUBE_MAP_${l[e]}`,a=[],s=[];for(let r=0;r<t.specularImages.length;r++){const i=n[t.specularImages[r][e]];r===t.specularImages.length-1&&a.push(i),s.push(i)}r.push(new Tiny.three.MipmapResource(a,Tiny.three.TARGETS[o])),i.push(new Tiny.three.MipmapResource(s,Tiny.three.TARGETS[o]))}const o=new Tiny.three.CubeMipmapResource(r,1),a=new Tiny.three.CubeMipmapTexture(o),s=new Tiny.three.CubeMipmapResource(i,t.specularImages.length),c=new Tiny.three.CubeMipmapTexture(s),d=new Tiny.three.ImageBasedLighting({specular:c,diffuse:a,intensity:1.8});Tiny.three.LightingEnvironment.main.imageBasedLighting=d}}}function w(){const[e,r]=c.exports.useState(null),[i,l]=c.exports.useState(null),[o,s]=c.exports.useState(""),[E,f]=c.exports.useState([]),T=c.exports.useCallback((()=>{try{const e=localStorage.getItem("gltfPreviewRecords")||"";f(JSON.parse(e))}catch(e){}}),[]),v=c.exports.useCallback((e=>{const t=[...E];t.push({name:e,url:e,key:t.length?t[t.length-1].key+1:0,previewTime:(new Date).toLocaleString()}),f(t),localStorage.setItem("gltfPreviewRecords",JSON.stringify(t))}),[E]),w=c.exports.useCallback((e=>{const t=[...E],n=t.findIndex((t=>t.key===e.key));-1!==n&&(t.splice(n,1),f(t)),localStorage.setItem("gltfPreviewRecords",JSON.stringify(t))}),[E]),C=c.exports.useCallback((()=>{const e=prompt("请为JSON文件命名",""),t=document.createElement("a");t.download=`${e}.json`,t.style.display="none";var n=new Blob([JSON.stringify(E.map((e=>({name:e.name,url:e.url}))))]);t.href=URL.createObjectURL(n),document.body.appendChild(t),t.click(),document.body.removeChild(t)}),[[E]]),S=c.exports.useCallback((e=>{const r=prompt("请输入模型名称",e.name);if(!r)return;const i=(l=a({},e),t(l,n({name:r})));var l;const o=[...E],s=o.findIndex((t=>t.key===e.key));-1!==s&&(o.splice(s,1,i),f(o)),localStorage.setItem("gltfPreviewRecords",JSON.stringify(o))}),[E]),x=c.exports.useCallback((()=>{if(!e)return;i&&i._destroy();const t=e.view.parentElement;Tiny.three.Camera.main=null,Tiny.three.LightingEnvironment.main.destroy(),Tiny.three.destroyTextureCache(),e.renderer3d.destroy(),Tiny.three.detach(e),e.destroy(!0,{children:!0,texture:!0,baseTexture:!0});const n=document.createElement("canvas");n.id="J-canvas",null==t||t.appendChild(n),r(null)}),[e,r]),I=c.exports.useCallback((e=>{x();const t={width:375,height:812};setTimeout((()=>{var n,i,a;const s=document.getElementById("J-canvas");s&&"screen"===(null==(n=s.parentElement)?void 0:n.className)&&(t.width=null==(i=s.parentElement)?void 0:i.clientWidth,t.height=null==(a=s.parentElement)?void 0:a.clientHeight);const c=new Tiny.Application({showFPS:!0,dpi:2,canvasId:"J-canvas",width:t.width,height:t.height,fixSize:!0,renderType:Tiny.RENDERER_TYPE.WEBGL,renderOptions:{antialias:!0,backgroundColor:1974304}});Tiny.three.attach(c);const d=new b({model:e||o});c.run(d),r(c),l(d);new Tiny.three.CameraOrbitControl(c.view).distance=1.5}),700)}),[x,r,o]);c.exports.useEffect((()=>{T()}),[]);const O=c.exports.useCallback((e=>{const t=document.createElement("input");document.body.appendChild(t),t.setAttribute("value",e),t.select(),document.execCommand("copy")&&(document.execCommand("copy"),d.success("复制成功")),document.body.removeChild(t)}),[]),k=[{title:"模型名称",dataIndex:"name",key:"name",render:(e,t)=>m.createElement("a",{href:t.url},e)},{title:"预览时间",dataIndex:"previewTime",key:"previewTime"},{title:"操作",key:"action",render:(e,t)=>m.createElement(m.Fragment,null,m.createElement(u,{onClick:()=>L(t.url)},"预览"),m.createElement(u,{onClick:()=>O(t.url)},"复制模型链接"),m.createElement(u,{onClick:()=>w(t)},"删除记录"),m.createElement(u,{onClick:()=>S(t)},"重命名"))}],L=e=>{s(e),I(e)};return m.createElement("div",{className:"app"},m.createElement("div",{className:"left-side"},m.createElement("h2",null,"预览记录"),m.createElement(u,{onClick:()=>C()},"批量导出JSON"),m.createElement(h,{columns:k,dataSource:E})),m.createElement("main",null,m.createElement("div",{className:"preview-input"},m.createElement(p.Search,{placeholder:"请输入 gltf 链接",allowClear:!0,enterButton:"预览",size:"large",onSearch:e=>{e?(s(e),I(e),v(e)):d.error("请先输入 gltf 链接")}})),m.createElement(g,{onChange:()=>{I()}},(e=>m.createElement(y.DeviceFrameset,a({},e),m.createElement("canvas",{id:"J-canvas"}))))))}function C(){return m.createElement(E,null,m.createElement(f,null,m.createElement(T,{path:"/"},m.createElement(w,null))))}v.render(m.createElement(m.StrictMode,null,m.createElement(C,null)),document.getElementById("root"));
